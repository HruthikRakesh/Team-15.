<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçá Grape Disease Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-theme: #6a0dad;
            --secondary-theme: #4b0082;
        }
        body { font-family: 'Poppins', sans-serif; }
        .theme-purple { --primary-theme: #6a0dad; --secondary-theme: #4b0082; }
        .theme-green { --primary-theme: #2e8b57; --secondary-theme: #3cb371; }
        .theme-blue { --primary-theme: #4169e1; --secondary-theme: #1e90ff; }
        .gradient-bg { background: linear-gradient(135deg, var(--primary-theme) 0%, var(--secondary-theme) 100%); }
        .disease-card { border-left: 4px solid var(--primary-theme); transition: all 0.3s ease; }
        .disease-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        #imagePreview { max-height: 300px; object-fit: contain; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50 theme-purple">
    <header class="sticky top-0 z-10 gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <span class="text-2xl font-bold">üçá GrapeCare</span>
                <div class="flex items-center space-x-2 bg-white/20 rounded-full p-1">
                    <span id="lang-en" class="lang-option cursor-pointer px-3 py-1 rounded-full bg-white text-[--primary-theme]">English</span>
                    <span id="lang-kn" class="lang-option cursor-pointer px-3 py-1 rounded-full">‡≤ï‡≤®‡≥ç‡≤®‡≤°</span>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button id="theme-purple" class="theme-btn w-6 h-6 rounded-full bg-purple-700"></button>
                <button id="theme-green" class="theme-btn w-6 h-6 rounded-full bg-green-600"></button>
                <button id="theme-blue" class="theme-btn w-6 h-6 rounded-full bg-blue-600"></button>
                <button id="dark-toggle" class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <section class="text-center mb-12">
            <h1 id="main-title" class="text-4xl font-bold text-[--primary-theme] mb-4"></h1>
            <p id="subtitle" class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto"></p>
        </section>
        <section class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden p-6 mb-8">
            <h2 id="upload-title" class="text-xl font-semibold text-[--secondary-theme] mb-4"></h2>
            <form id="upload-form" class="space-y-4">
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 bg-gray-50 dark:bg-gray-700 transition hover:border-[--primary-theme]">
                    <input type="file" id="image-upload" accept="image/*" class="hidden" required>
                    <label for="image-upload" class="cursor-pointer flex flex-col items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-[--primary-theme]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <span id="upload-text" class="mt-2 text-sm text-gray-500 dark:text-gray-300"></span>
                    </label>
                </div>
                <img id="imagePreview" class="hidden w-full mt-4 rounded-lg">
                <button type="submit" id="analyze-btn" class="w-full gradient-bg hover:opacity-90 text-white font-medium rounded-lg py-3 px-4 transition duration-200 flex items-center justify-center">
                    <span id="analyze-text"></span>
                    <svg id="analyze-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </form>
        </section>
        <section id="results-section" class="hidden max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden p-6 mb-8">
            <h2 id="results-title" class="text-xl font-semibold text-[--secondary-theme] mb-4"></h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 id="disease-label" class="text-lg font-medium"></h3>
                    <div class="flex items-center space-x-2">
                        <span id="model-accuracy" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"></span>
                        <span id="confidence" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium"></span>
                    </div>
                </div>
                <p id="disease-name" class="text-2xl font-bold text-[--primary-theme]"></p>
                <div class="w-full max-w-xs mx-auto my-4"><canvas id="predictionChart"></canvas></div>
                <img id="analyzed-image" src="" alt="Analyzed grape leaf image" class="w-full rounded-lg border">
                <div class="mt-6">
                    <h4 id="treatment-title" class="font-medium text-lg mb-2"></h4>
                    <p id="treatment-tips" class="bg-blue-50 text-blue-900 rounded-lg p-4"></p>
                </div>
            </div>
        </section>
        <section class="max-w-6xl mx-auto mb-12">
            <h2 id="disease-info-title" class="text-2xl font-bold text-center text-[--secondary-theme] mb-8"></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="disease-card bg-white dark:bg-gray-800 rounded-lg shadow-md p-6"><div class="p-5"><h3 id="disease1-title" class="text-xl font-semibold mb-2"></h3><p id="disease1-desc" class="text-gray-600 dark:text-gray-300 mb-4"></p></div></div>
                <div class="disease-card bg-white dark:bg-gray-800 rounded-lg shadow-md p-6"><div class="p-5"><h3 id="disease2-title" class="text-xl font-semibold mb-2"></h3><p id="disease2-desc" class="text-gray-600 dark:text-gray-300 mb-4"></p></div></div>
                <div class="disease-card bg-white dark:bg-gray-800 rounded-lg shadow-md p-6"><div class="p-5"><h3 id="disease3-title" class="text-xl font-semibold mb-2"></h3><p id="disease3-desc" class="text-gray-600 dark:text-gray-300 mb-4"></p></div></div>
                <div class="disease-card bg-white dark:bg-gray-800 rounded-lg shadow-md p-6"><div class="p-5"><h3 id="disease4-title" class="text-xl font-semibold mb-2"></h3><p id="disease4-desc" class="text-gray-600 dark:text-gray-300 mb-4"></p></div></div>
            </div>
        </section>
        <section class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-8">
            <div class="p-6">
                <h2 id="chat-title" class="text-xl font-semibold text-[--secondary-theme] mb-4"></h2>
                <div id="chat-box" class="h-64 overflow-y-auto mb-4 space-y-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex justify-start"><div class="bg-[--primary-theme] text-white rounded-lg max-w-xs p-3"><p id="welcome-message"></p></div></div>
                </div>
                <div class="flex space-x-2">
                    <input id="user-input" type="text" placeholder="Type your question..." class="flex-1 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[--primary-theme] dark:bg-gray-700">
                    <button id="send-btn" class="gradient-bg hover:opacity-90 text-white px-4 py-2 rounded-lg transition duration-200">Send</button>
                </div>
                <div class="mt-3 grid grid-cols-2 gap-2">
                    <button class="quick-question bg-gray-100 hover:bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-lg px-3 py-1 text-sm transition duration-200"></button>
                    <button class="quick-question bg-gray-100 hover:bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-lg px-3 py-1 text-sm transition duration-200"></button>
                    <button class="quick-question bg-gray-100 hover:bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-lg px-3 py-1 text-sm transition duration-200"></button>
                    <button class="quick-question bg-gray-100 hover:bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-lg px-3 py-1 text-sm transition duration-200"></button>
                </div>
            </div>
        </section>
    </main>
    <footer class="gradient-bg text-white py-6 mt-12">
       <div class="container mx-auto px-4 text-center">
            <p id="footer-text"></p>
            <p class="text-sm opacity-75">For educational purposes only | Consult an expert for serious plant health issues</p>
        </div>
    </footer>

    <script>
        const translations = {
            en: { mainTitle: "Grape Disease Detector", subtitle: "Upload an image of grape leaves to detect diseases and get treatment recommendations", uploadTitle: "Upload Grape Leaf Image", uploadText: "Click to select an image", analyzeBtn: "Analyze Image", resultsTitle: "Analysis Results", diseaseLabel: "Disease Detected:", treatmentTitle: "Recommended Treatment", diseaseInfoTitle: "Common Grape Diseases", diseaseBlackRot: "Black Rot", diseaseEsca: "ESCA", diseaseHealthy: "Healthy", diseaseBlight: "Leaf Blight", chatTitle: "Ask GrapeCare Assistant", welcomeMessage: "Hello! I'm your grape disease assistant. How can I help you today?", footerText: "¬© 2025 GrapeCare", quickQuestions: ["Black Rot", "ESCA", "Healthy Grapes", "Treatment Tips"], confidenceLabel: "Confidence:", modelAccuracyLabel: "Model Accuracy:", healthyLabel: "Healthy", diseaseDescriptions: { blackRot: "Fungal disease causing dark spots on leaves and fruit rot.", esca: "Complex disease causing leaf discoloration and wood decay.", healthy: "Healthy grape leaves should be vibrant green.", blight: "Bacterial disease causing irregular brown patches." } },
            kn: { mainTitle: "‡≤¶‡≥ç‡≤∞‡≤æ‡≤ï‡≥ç‡≤∑‡≤ø ‡≤ï‡≤æ‡≤Ø‡≤ø‡≤≤‡≥Ü ‡≤™‡≤§‡≥ç‡≤§‡≥Ü‡≤ó‡≤æ‡≤∞", subtitle: "‡≤¶‡≥ç‡≤∞‡≤æ‡≤ï‡≥ç‡≤∑‡≤ø ‡≤é‡≤≤‡≥Ü‡≤ó‡≤≥ ‡≤ö‡≤ø‡≤§‡≥ç‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ö‡≤™‡≥ç‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤ö‡≤ø‡≤ï‡≤ø‡≤§‡≥ç‡≤∏‡≥Ü ‡≤∂‡≤ø‡≤´‡≤æ‡≤∞‡≤∏‡≥Å‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤™‡≤°‡≥Ü‡≤Ø‡≤ø‡≤∞‡≤ø", uploadTitle: "‡≤¶‡≥ç‡≤∞‡≤æ‡≤ï‡≥ç‡≤∑‡≤ø ‡≤é‡≤≤‡≥Ü ‡≤ö‡≤ø‡≤§‡≥ç‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ö‡≤™‡≥ç‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø", uploadText: "‡≤ö‡≤ø‡≤§‡≥ç‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤ï‡≥ç‡≤≤‡≤ø‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø", analyzeBtn: "‡≤ö‡≤ø‡≤§‡≥ç‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤µ‡≤ø‡≤∂‡≥ç‡≤≤‡≥á‡≤∑‡≤ø‡≤∏‡≤ø", resultsTitle: "‡≤µ‡≤ø‡≤∂‡≥ç‡≤≤‡≥á‡≤∑‡≤£‡≥Ü ‡≤´‡≤≤‡≤ø‡≤§‡≤æ‡≤Ç‡≤∂‡≤ó‡≤≥‡≥Å", diseaseLabel: "‡≤ï‡≤æ‡≤Ø‡≤ø‡≤≤‡≥Ü ‡≤™‡≤§‡≥ç‡≤§‡≥Ü‡≤Ø‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü:", treatmentTitle: "‡≤∂‡≤ø‡≤´‡≤æ‡≤∞‡≤∏‡≥Å ‡≤Æ‡≤æ‡≤°‡≤ø‡≤¶ ‡≤ö‡≤ø‡≤ï‡≤ø‡≤§‡≥ç‡≤∏‡≥Ü", diseaseInfoTitle: "‡≤∏‡≤æ‡≤Æ‡≤æ‡≤®‡≥ç‡≤Ø ‡≤¶‡≥ç‡≤∞‡≤æ‡≤ï‡≥ç‡≤∑‡≤ø ‡≤ï‡≤æ‡≤Ø‡≤ø‡≤≤‡≥Ü‡≤ó‡≤≥‡≥Å", diseaseBlackRot: "‡≤ï‡≤™‡≥ç‡≤™‡≥Å ‡≤ï‡≥ä‡≤≥‡≥Ü", diseaseEsca: "‡≤é‡≤∏‡≥ç‡≤ï‡≤æ", diseaseHealthy: "‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø‡≤ï‡≤∞", diseaseBlight: "‡≤¨‡≥ç‡≤≤‡≥à‡≤ü‡≥ç ‡≤é‡≤≤‡≥Ü", chatTitle: "GrapeCare ‡≤∏‡≤π‡≤æ‡≤Ø‡≤ï‡≤®‡≤®‡≥ç‡≤®‡≥Å ‡≤ï‡≥á‡≤≥‡≤ø", welcomeMessage: "‡≤®‡≤Æ‡≤∏‡≥ç‡≤ï‡≤æ‡≤∞! ‡≤®‡≤æ‡≤®‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤¶‡≥ç‡≤∞‡≤æ‡≤ï‡≥ç‡≤∑‡≤ø ‡≤ï‡≤æ‡≤Ø‡≤ø‡≤≤‡≥Ü ‡≤∏‡≤π‡≤æ‡≤Ø‡≤ï.", footerText: "¬© 2025 ‡≤¶‡≥ç‡≤∞‡≤æ‡≤ï‡≥ç‡≤∑‡≤ø ‡≤Ü‡≤∞‡≥à‡≤ï‡≥Ü", quickQuestions: ["‡≤ï‡≤™‡≥ç‡≤™‡≥Å ‡≤ï‡≥ä‡≤≥‡≥Ü", "‡≤é‡≤∏‡≥ç‡≤ï‡≤æ", "‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø‡≤ï‡≤∞ ‡≤¶‡≥ç‡≤∞‡≤æ‡≤ï‡≥ç‡≤∑‡≤ø", "‡≤ö‡≤ø‡≤ï‡≤ø‡≤§‡≥ç‡≤∏‡≥Ü ‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≥Å"], confidenceLabel: "‡≤µ‡≤ø‡≤∂‡≥ç‡≤µ‡≤æ‡≤∏:", modelAccuracyLabel: "‡≤Æ‡≤æ‡≤¶‡≤∞‡≤ø ‡≤®‡≤ø‡≤ñ‡≤∞‡≤§‡≥Ü:", healthyLabel: "‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø‡≤ï‡≤∞", diseaseDescriptions: { blackRot: "‡≤é‡≤≤‡≥Ü‡≤ó‡≤≥‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤π‡≤£‡≥ç‡≤£‡≥Å ‡≤ï‡≥ä‡≤≥‡≥Ü‡≤§‡≤¶ ‡≤Æ‡≥á‡≤≤‡≥Ü ‡≤ï‡≤™‡≥ç‡≤™‡≥Å ‡≤ï‡≤≤‡≥Ü‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤â‡≤Ç‡≤ü‡≥Å‡≤Æ‡≤æ‡≤°‡≥Å‡≤µ ‡≤´‡≤Ç‡≤ó‡≤≤‡≥ç ‡≤∞‡≥ã‡≤ó.", esca: "‡≤é‡≤≤‡≥Ü‡≤ó‡≤≥ ‡≤¨‡≤£‡≥ç‡≤£ ‡≤¨‡≤¶‡≤≤‡≤æ‡≤µ‡≤£‡≥Ü ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤Æ‡≤∞‡≤¶ ‡≤ï‡≥ä‡≤≥‡≥Ü‡≤§‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤â‡≤Ç‡≤ü‡≥Å‡≤Æ‡≤æ‡≤°‡≥Å‡≤µ ‡≤∏‡≤Ç‡≤ï‡≥Ä‡≤∞‡≥ç‡≤£ ‡≤∞‡≥ã‡≤ó.", healthy: "‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø‡≤ï‡≤∞ ‡≤¶‡≥ç‡≤∞‡≤æ‡≤ï‡≥ç‡≤∑‡≤ø ‡≤é‡≤≤‡≥Ü‡≤ó‡≤≥‡≥Å ‡≤ï‡≤≤‡≥Ü‡≤ó‡≤≥‡≥Å ‡≤á‡≤≤‡≥ç‡≤≤‡≤¶‡≥Ü ‡≤π‡≤∏‡≤ø‡≤∞‡≤æ‡≤ó‡≤ø‡≤∞‡≤¨‡≥á‡≤ï‡≥Å.", blight: "‡≤é‡≤≤‡≥Ü‡≤ó‡≤≥ ‡≤Æ‡≥á‡≤≤‡≥Ü ‡≤Ö‡≤®‡≤ø‡≤Ø‡≤Æ‡≤ø‡≤§ ‡≤ï‡≤Ç‡≤¶‡≥Å ‡≤™‡≥ç‡≤Ø‡≤æ‡≤ö‡≥ç‡≤ó‡≤≥‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤π‡≤£‡≥ç‡≤£‡≤ø‡≤® ‡≤ó‡≥Å‡≤£‡≤Æ‡≤ü‡≥ç‡≤ü‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤ï‡≤°‡≤ø‡≤Æ‡≥Ü ‡≤Æ‡≤æ‡≤°‡≥Å‡≤µ ‡≤¨‡≥ç‡≤Ø‡≤æ‡≤ï‡≥ç‡≤ü‡≥Ä‡≤∞‡≤ø‡≤Ø‡≤æ‡≤¶ ‡≤∞‡≥ã‡≤ó." } }
        };

        function updateLanguage(lang) {
            const langData = translations[lang];
            const setText = (id, key) => { const el = document.getElementById(id); if (el) el.textContent = langData[key]; };
            setText('main-title', 'mainTitle'); setText('subtitle', 'subtitle'); setText('upload-title', 'uploadTitle'); setText('upload-text', 'uploadText'); setText('analyze-text', 'analyzeBtn'); setText('results-title', 'resultsTitle'); setText('disease-label', 'diseaseLabel'); setText('treatment-title', 'treatmentTitle'); setText('disease-info-title', 'diseaseInfoTitle'); setText('chat-title', 'chatTitle'); setText('footer-text', 'footerText'); setText('welcome-message', 'welcomeMessage');
            setText('disease1-title', 'diseaseBlackRot'); setText('disease2-title', 'diseaseEsca'); setText('disease3-title', 'diseaseHealthy'); setText('disease4-title', 'diseaseBlight');
            document.getElementById('disease1-desc').textContent = langData.diseaseDescriptions.blackRot; document.getElementById('disease2-desc').textContent = langData.diseaseDescriptions.esca; document.getElementById('disease3-desc').textContent = langData.diseaseDescriptions.healthy; document.getElementById('disease4-desc').textContent = langData.diseaseDescriptions.blight;
            const quickQuestions = document.querySelectorAll('.quick-question');
            quickQuestions.forEach((button, index) => { button.textContent = langData.quickQuestions[index]; });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const darkToggle = document.getElementById('dark-toggle');
            darkToggle.addEventListener('click', () => { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode')); });
            if (localStorage.getItem('darkMode') === 'true') { document.body.classList.add('dark-mode'); }
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', function() { document.body.className = document.body.className.replace(/theme-\w+/, `theme-${this.id.replace('theme-', '')}`); localStorage.setItem('selectedTheme', this.id.replace('theme-', '')); });
            });
            const savedTheme = localStorage.getItem('selectedTheme') || 'purple';
            document.body.classList.add(`theme-${savedTheme}`);
            document.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.lang-option').forEach(opt => opt.classList.remove('bg-white', 'text-[--primary-theme]'));
                    this.classList.add('bg-white', 'text-[--primary-theme]');
                    const lang = this.id.replace('lang-', '');
                    localStorage.setItem('selectedLanguage', lang);
                    updateLanguage(lang);
                });
            });

            document.getElementById('image-upload').addEventListener('change', function(e) {
                const reader = new FileReader();
                reader.onload = function() { const output = document.getElementById('imagePreview'); output.src = reader.result; output.classList.remove('hidden'); };
                reader.readAsDataURL(e.target.files[0]);
            });

            const chatBox = document.getElementById('chat-box');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            function addChatMessage(message, isUser = false) {
                const bubbleClass = isUser ? 'bg-[--secondary-theme] text-white rounded-lg rounded-br-none' : 'bg-[--primary-theme] text-white rounded-lg rounded-bl-none';
                const alignClass = isUser ? 'justify-end' : 'justify-start';
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${alignClass} mb-2`;
                const p = document.createElement('p');
                p.className = `${bubbleClass} max-w-xs p-3 break-words`;
                p.innerHTML = message;
                messageDiv.appendChild(p);
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
                return p;
            }
            async function sendMessage() {
                const message = userInput.value.trim();
                if (message === '') return;
                addChatMessage(message, true);
                userInput.value = '';
                sendBtn.disabled = true;
                const thinkingBubble = addChatMessage('Thinking...', false);
                try {
                    const formData = new FormData();
                    formData.append('message', message);
                    formData.append('language', localStorage.getItem('selectedLanguage') || 'en');
                    const response = await fetch('/chat', { method: 'POST', body: formData });
                    if (!response.ok) { throw new Error('Network response was not ok'); }
                    const data = await response.json();
                    thinkingBubble.innerHTML = data.response;
                } catch (error) {
                    console.error('Error:', error);
                    thinkingBubble.innerHTML = "Sorry, something went wrong. Please try again.";
                } finally {
                    sendBtn.disabled = false;
                    userInput.focus();
                }
            }
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { sendMessage(); } });
            document.querySelectorAll('.quick-question').forEach(button => {
                button.addEventListener('click', function() { userInput.value = this.textContent.trim(); sendMessage(); });
            });

            document.getElementById('upload-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const lang = localStorage.getItem('selectedLanguage') || 'en';
                const fileInput = document.getElementById('image-upload');
                if (!fileInput.files.length) { alert(translations[lang].uploadText); return; }
                const analyzeBtn = document.getElementById('analyze-btn');
                const analyzeText = document.getElementById('analyze-text');
                const spinner = document.getElementById('analyze-spinner');
                analyzeText.textContent = translations[lang].analyzeBtn + '...';
                spinner.classList.remove('hidden');
                analyzeBtn.disabled = true;
                try {
                    const formData = new FormData();
                    formData.append('image', fileInput.files[0]);
                    formData.append('language', lang);
                    const response = await fetch('/predict', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('Analysis failed');
                    const result = await response.json();
                    
                    document.getElementById('disease-name').textContent = result.prediction;
                    document.getElementById('confidence').textContent = `${translations[lang].confidenceLabel} ${result.confidence}%`;
                    document.getElementById('model-accuracy').textContent = `${translations[lang].modelAccuracyLabel} ${result.model_accuracy}%`;
                    document.getElementById('treatment-tips').textContent = result.treatment;
                    document.getElementById('analyzed-image').src = result.image_url;

                    const ctx = document.getElementById('predictionChart').getContext('2d');
                    if (window.myPredictionChart) { window.myPredictionChart.destroy(); }
                    
                    let chartData, chartLabels, chartColors, chartTitle = translations[lang].resultsTitle;
                    const topPredictionIndex = result.all_predictions.probabilities.indexOf(Math.max(...result.all_predictions.probabilities));
                    const englishPrediction = result.all_predictions.labels[topPredictionIndex];

                    if (englishPrediction.toLowerCase() === 'healthy') {
                        chartLabels = [result.prediction];
                        chartData = [100];
                        chartColors = ['rgba(144, 238, 144, 0.8)'];
                    } else {
                        const diseasePercentage = result.confidence;
                        const healthyPercentage = 100 - diseasePercentage;
                        chartLabels = [result.prediction, translations[lang].healthyLabel];
                        chartData = [diseasePercentage, healthyPercentage];
                        chartColors = ['rgba(0, 0, 0, 0.7)', 'rgba(144, 238, 144, 0.8)'];
                    }
                    
                    window.myPredictionChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: chartLabels,
                            datasets: [{ label: 'Health Status (%)', data: chartData, backgroundColor: chartColors, borderColor: '#fff', borderWidth: 2 }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top', labels: { font: { size: 14 } } },
                                title: { display: true, text: chartTitle, font: { size: 16 } }
                            }
                        }
                    });

                    document.getElementById('results-section').classList.remove('hidden');
                    document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error analyzing image. Please try again.');
                } finally {
                    analyzeText.textContent = translations[lang].analyzeBtn;
                    spinner.classList.add('hidden');
                    analyzeBtn.disabled = false;
                }
            });

            // Set initial language on page load
            const initialLang = localStorage.getItem('selectedLanguage') || 'en';
            if(document.getElementById(`lang-${initialLang}`)) {
                document.getElementById(`lang-${initialLang}`).click();
            } else {
                updateLanguage('en');
            }
        });
    </script>
</body>
</html>